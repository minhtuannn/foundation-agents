Diabetes Prediction Challenge
1. Introduction
Let"s use a lightgbm model to predict the likeliness of a patient to have diabetes. Prior to that, we will explore the data, design visuals then build workflows and models to predict the diagnosis. Let's make it bright, dynamic, and effective. The predictions will then be submitted to s5e12 of the swag competition.
2. Get the libraries and tools
unfold_moreShow hidden code
pandas version: 2.2.3
numpy version: 1.26.4
seaborn version: 0.12.2
2. Get and preview the datasets
unfold_moreShow hidden code
Out[2]:
age alcohol_consumption_per_week physical_activity_minutes_per_week diet_score sleep_hours_per_day screen_time_hours_per_day bmi waist_to_hip_ratio systolic_bp diastolic_bp ... gender ethnicity education_level income_level smoking_status employment_status family_history_diabetes hypertension_history cardiovascular_history diagnosed_diabetes
id
0 31 1 45 7.7 6.8 6.1 33.4 0.93 112 70 ... Female Hispanic Highschool Lower-Middle Current Employed 0 0 0 1.0
1 50 2 73 5.7 6.5 5.8 23.8 0.83 120 77 ... Female White Highschool Upper-Middle Never Employed 0 0 0 1.0
2 32 3 158 8.5 7.4 9.1 24.1 0.83 95 89 ... Male Hispanic Highschool Lower-Middle Never Retired 0 0 0 0.0
3 54 3 77 4.6 7.0 9.2 26.6 0.83 121 69 ... Female White Highschool Lower-Middle Current Employed 0 1 0 1.0
4 54 1 55 5.7 6.2 5.1 28.8 0.90 108 60 ... Male White Highschool Upper-Middle Never Retired 0 1 0 1.0
5 rows Ã— 25 columns
In [3]:
or_00.head()
Out[3]:
age alcohol_consumption_per_week physical_activity_minutes_per_week diet_score sleep_hours_per_day screen_time_hours_per_day bmi waist_to_hip_ratio systolic_bp diastolic_bp ... gender ethnicity education_level income_level smoking_status employment_status family_history_diabetes hypertension_history cardiovascular_history diagnosed_diabetes
0 58 0 215 5.7 7.9 7.9 30.5 0.89 134 78 ... Male Asian Highschool Lower-Middle Never Employed 0 0 0 1
1 48 1 143 6.7 6.5 8.7 23.1 0.80 129 76 ... Female White Highschool Middle Former Employed 0 0 0 0
2 60 1 57 6.4 10.0 8.1 22.2 0.81 115 73 ... Male Hispanic Highschool Middle Never Unemployed 1 0 0 1
3 74 0 49 3.4 6.6 5.2 26.8 0.88 120 93 ... Female Black Highschool Low Never Retired 0 0 0 1
4 46 1 109 7.2 7.4 5.0 21.2 0.78 92 67 ... Male White Graduate Middle Never Retired 0 0 0 1
5 rows Ã— 25 columns
3. Explore the datasets
3.1 Dataset info and description
unfold_moreShow hidden code
shape of train set: (700000, 25)
shape of test set: (300000, 24)
shape of external set: (100000, 25)
unfold_moreShow hidden code
<class 'pandas.core.frame.DataFrame'>
Index: 700000 entries, 0 to 699999
Data columns (total 25 columns):
 #   Column                              Non-Null Count   Dtype  
---  ------                              --------------   -----  
 0   age                                 700000 non-null  int64  
 1   alcohol_consumption_per_week        700000 non-null  int64  
 2   physical_activity_minutes_per_week  700000 non-null  int64  
 3   diet_score                          700000 non-null  float64
 4   sleep_hours_per_day                 700000 non-null  float64
 5   screen_time_hours_per_day           700000 non-null  float64
 6   bmi                                 700000 non-null  float64
 7   waist_to_hip_ratio                  700000 non-null  float64
 8   systolic_bp                         700000 non-null  int64  
 9   diastolic_bp                        700000 non-null  int64  
 10  heart_rate                          700000 non-null  int64  
 11  cholesterol_total                   700000 non-null  int64  
 12  hdl_cholesterol                     700000 non-null  int64  
 13  ldl_cholesterol                     700000 non-null  int64  
 14  triglycerides                       700000 non-null  int64  
 15  gender                              700000 non-null  object 
 16  ethnicity                           700000 non-null  object 
 17  education_level                     700000 non-null  object 
 18  income_level                        700000 non-null  object 
 19  smoking_status                      700000 non-null  object 
 20  employment_status                   700000 non-null  object 
 21  family_history_diabetes             700000 non-null  int64  
 22  hypertension_history                700000 non-null  int64  
 23  cardiovascular_history              700000 non-null  int64  
 24  diagnosed_diabetes                  700000 non-null  float64
dtypes: float64(6), int64(13), object(6)
memory usage: 138.9+ MB
unfold_moreShow hidden code
unfold_moreShow hidden code
Out[7]:
count mean std min 25% 50% 75% max
age 700000.0 50.359734 11.655520 19.00 42.00 50.00 58.00 89.00
alcohol_consumption_per_week 700000.0 2.072411 1.048189 1.00 1.00 2.00 3.00 9.00
physical_activity_minutes_per_week 700000.0 80.230803 51.195071 1.00 49.00 71.00 96.00 747.00
diet_score 700000.0 5.963695 1.463336 0.10 5.00 6.00 7.00 9.90
sleep_hours_per_day 700000.0 7.002200 0.901907 3.10 6.40 7.00 7.60 9.90
screen_time_hours_per_day 700000.0 6.012733 2.022707 0.60 4.60 6.00 7.40 16.50
bmi 700000.0 25.874684 2.860705 15.10 23.90 25.90 27.80 38.40
waist_to_hip_ratio 700000.0 0.858766 0.037980 0.68 0.83 0.86 0.88 1.05
systolic_bp 700000.0 116.294193 11.010390 91.00 108.00 116.00 124.00 163.00
diastolic_bp 700000.0 75.440924 6.825775 51.00 71.00 75.00 80.00 104.00
heart_rate 700000.0 70.167749 6.938722 42.00 65.00 70.00 75.00 101.00
cholesterol_total 700000.0 186.818801 16.730832 117.00 175.00 187.00 199.00 289.00
hdl_cholesterol 700000.0 53.823214 8.266545 21.00 48.00 54.00 59.00 90.00
ldl_cholesterol 700000.0 102.905854 19.022416 51.00 89.00 103.00 116.00 205.00
triglycerides 700000.0 123.081850 24.739397 31.00 106.00 123.00 139.00 290.00
family_history_diabetes 700000.0 0.149401 0.356484 0.00 0.00 0.00 0.00 1.00
hypertension_history 700000.0 0.181990 0.385837 0.00 0.00 0.00 0.00 1.00
cardiovascular_history 700000.0 0.030324 0.171478 0.00 0.00 0.00 0.00 1.00
unfold_moreShow hidden code
Out[8]:
count unique top freq
gender 700000 3 Female 363237
ethnicity 700000 5 White 386153
education_level 700000 4 Highschool 344145
income_level 700000 5 Middle 290557
smoking_status 700000 3 Never 494448
employment_status 700000 4 Employed 516170
diagnosed_diabetes 700000 2 1 436307
unfold_moreShow hidden code
unfold_moreShow hidden code
3.2 Compare distributions in train and test sets
unfold_moreShow hidden code
unfold_moreShow hidden code
3.3 Compare distributions when grouped by diagnosis
unfold_moreShow hidden code
unfold_moreShow hidden code
In [15]:
preprocess_data = False
use_cat_mapping = False


# Your mapping dictionaries
gender__dico = {'Male': -1, "Female": 1, 'Other': 0}
education_level__dico = {'No formal': 0, 'Highschool': 1, 'Graduate': 2, 'Postgraduate': 3}
smoking_status__dico = {'Never': 0, 'Former': 1, 'Current': 2}  
income_level__dico = {'Low': 0, 'Lower-Middle': 1, 'Middle': 2, 'Upper-Middle': 3, 'High': 4}
employment_status__dico = {'Unemployed': 0, 'Student': 1, 'Employed': 2, 'Retired': 3}

# Collect mappings in one place keyed by column name
cat_mappings = {
    'gender': gender__dico,
    'education_level': education_level__dico,
    'smoking_status': smoking_status__dico,    # be careful with name consistency
    'income_level': income_level__dico,
    'employment_status': employment_status__dico,
}


# Apply to each dataframe
for df in [tr_00, ts_00, or_00]:
    if preprocess_data:
        df['pysicaL_activity_*_sleep_hoursðŸ§®'] = df['physical_activity_minutes_per_week']/df['sleep_hours_per_day']
        df['sleep_hours_per_day_*_sleep_hoursðŸ§®'] = df['sleep_hours_per_day']/df['screen_time_hours_per_day']
        df['bmi_*_diet_scoreðŸ§®'] = df['bmi']/df['diet_score']
        df['diastolic_*_sistolicðŸ§®'] = df['diastolic_bp']/df['systolic_bp']
        df['bmi_*_diastolic_bp'] = df['bmi']*df['diastolic_bp']
        df['diastolic_bp-systolic_bp_*_bmi'] = (df['diastolic_bp']-df['systolic_bp'])/df['bmi']
        if use_cat_mapping:
            for col, mapping in cat_mappings.items():
                # Replace with numeric codes; keep any unknowns as-is
                df[col] = df[col].replace(mapping)
        
                # Optional: convert to nullable integer dtype (handles any non-mapped leftovers)
                # If you are sure everything maps to integers, you can use int instead.
                df[col] = df[col].astype('Int64')  # nullable integer dtype
        else:
            pass
    else:
        pass

tr_00.head(3)
Out[15]:
age alcohol_consumption_per_week physical_activity_minutes_per_week diet_score sleep_hours_per_day screen_time_hours_per_day bmi waist_to_hip_ratio systolic_bp diastolic_bp ... gender ethnicity education_level income_level smoking_status employment_status family_history_diabetes hypertension_history cardiovascular_history diagnosed_diabetes
id
0 31 1 45 7.7 6.8 6.1 33.4 0.93 112 70 ... Female Hispanic Highschool Lower-Middle Current Employed 0 0 0 1
1 50 2 73 5.7 6.5 5.8 23.8 0.83 120 77 ... Female White Highschool Upper-Middle Never Employed 0 0 0 1
2 32 3 158 8.5 7.4 9.1 24.1 0.83 95 89 ... Male Hispanic Highschool Lower-Middle Never Retired 0 0 0 0
3 rows Ã— 25 columns
Handle Outliers in num_features
unfold_moreShow hidden code
In [17]:
plot_num_distribution_grid(tr_01, grouper=target)
4. Model Preparation
4.1 Fit the Model and explain the model
unfold_moreShow hidden code
unfold_moreShow hidden code
In [20]:
# The preprocessor used to handle cat_features for xgb and voting classifiers
preprocessor = ColumnTransformer(
    transformers=[
        # ('Ordinal_encoder', ce.OrdinalEncoder(), cat_feats),
       ('BDE_encoder', ce.BackwardDifferenceEncoder(), cat_feats)
    ],  
    remainder= 'passthrough',
    n_jobs=-1
)
unfold_moreShow hidden code
unfold_moreShow hidden code
In [23]:
best_params = Run_Pass_lgbm_study(n_trials=1)
No need to run Optuna, we will use the parameters obtained earlier.

Best parameters: {'n_estimators': 960, 'learning_rate': 0.6019675140772736, 'max_depth': 2, 'num_leaves': 88, 'reg_alpha': 0.9945293630381706, 'reg_lambda': 0.9849067535604036}
In [24]:
# The estimator
lgb = LGBMClassifier(**best_params, verbose=-1)

# the model pipeline
lgb_pipe = Pipeline(
    [
        ('preprocessor', preprocessor), 
        ('estimator', lgb)
    ]
)
In [25]:
lgb_pipe.fit( X, y)
Out[25]:

Pipeline
preprocessor: ColumnTransformer
BDE_encoder
BackwardDifferenceEncoder
remainder
passthrough
LGBMClassifier
unfold_moreShow hidden code
unfold_moreShow hidden code
Out[27]:
Split_Importances Gain_Importances
BDE_encoder__employment_status_2 2 1.040387
BDE_encoder__income_level_3 2 4.927827
BDE_encoder__smoking_status_0 3 5.446094
BDE_encoder__ethnicity_1 5 6.630614
BDE_encoder__ethnicity_0 3 8.608074
BDE_encoder__ethnicity_3 4 10.604262
BDE_encoder__education_level_0 4 11.732944
BDE_encoder__ethnicity_2 4 14.857552
BDE_encoder__employment_status_0 6 21.549386
BDE_encoder__income_level_0 3 22.809690
BDE_encoder__education_level_2 6 22.893002
BDE_encoder__gender_1 5 23.084310
BDE_encoder__employment_status_1 5 25.412668
BDE_encoder__gender_0 6 27.240410
BDE_encoder__income_level_1 6 37.242250
BDE_encoder__smoking_status_1 8 37.506960
BDE_encoder__income_level_2 8 39.956190
BDE_encoder__education_level_1 8 45.462270
BDE_encoder__hypertension_history 9 61.443809
BDE_encoder__cardiovascular_history 8 77.938699
remainder__alcohol_consumption_per_week 24 102.636669
remainder__sleep_hours_per_day 98 319.212099
remainder__diastolic_bp 85 349.556050
remainder__waist_to_hip_ratio 92 570.726538
remainder__screen_time_hours_per_day 137 682.165453
remainder__hdl_cholesterol 98 822.943612
remainder__systolic_bp 152 1013.828458
remainder__heart_rate 140 1075.833616
remainder__cholesterol_total 212 1221.859108
remainder__diet_score 128 1253.151924
remainder__ldl_cholesterol 236 2980.150119
remainder__bmi 197 4308.984899
remainder__triglycerides 319 7371.382800
remainder__age 230 19136.600324
BDE_encoder__family_history_diabetes 28 32780.684128
remainder__physical_activity_minutes_per_week 597 40116.792823
unfold_moreShow hidden code
Out[28]:
<Axes: title={'center': 'Split_Importances'}>
unfold_moreShow hidden code
Out[29]:
<Axes: title={'center': 'Gain_Importances'}>
4.2 Crossvalidate the Model
unfold_moreShow hidden code
ðŸš¨ðŸš¨ðŸš¨ Working on fold 1 of 6
                               â€¢â€¢â€¢â€¢â€¢> Fold_1 AUC: 0.727075 âœ…

ðŸš¨ðŸš¨ðŸš¨ Working on fold 2 of 6
                               â€¢â€¢â€¢â€¢â€¢> Fold_2 AUC: 0.727492 âœ…

ðŸš¨ðŸš¨ðŸš¨ Working on fold 3 of 6
                               â€¢â€¢â€¢â€¢â€¢> Fold_3 AUC: 0.728095 âœ…

ðŸš¨ðŸš¨ðŸš¨ Working on fold 4 of 6
                               â€¢â€¢â€¢â€¢â€¢> Fold_4 AUC: 0.729403 âœ…

ðŸš¨ðŸš¨ðŸš¨ Working on fold 5 of 6
                               â€¢â€¢â€¢â€¢â€¢> Fold_5 AUC: 0.728453 âœ…

ðŸš¨ðŸš¨ðŸš¨ Working on fold 6 of 6
                               â€¢â€¢â€¢â€¢â€¢> Fold_6 AUC: 0.728816 âœ…
4.3 Prediction on test data and submission
In [31]:
sb_00[target] = lgb_pipe.predict_proba(ts_01)[:,1]

sb_00.head()
Out[31]:
id diagnosed_diabetes
0 700000 0.457960
1 700001 0.680419
2 700002 0.741796
3 700003 0.375794
4 700004 0.912299
unfold_moreShow hidden code
unfold_moreShow hidden code
The file is ready for submission âœ…